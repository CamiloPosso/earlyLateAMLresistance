---
title: "Sunil Ex17 Pathway + Kinase heatmaps"
author: "Camilo Posso"
date: "07/06/2021"
output: 
  html_document:
    code_folding: hide
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Metadata

```{r libraries and setup, include=FALSE}
library(kableExtra)
library(amlresistancenetworks)
library(stats)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(readr)
source("../Util/synapseUtil.R")

####### Make sure to run the corresponding script to make the plots. It is in the Making Plots folder.

# corrected for loading mass and plexID, long time and subtle
p.site.corrected <- querySynapseTable("syn25706631")

phos.dat <- p.site.corrected
phos.dat$Peptide <- sub("^.*@(.*)$", "\\1", phos.dat$Accession)
phos.dat$site <- sub("^(.*)@.*$", "\\1", phos.dat$Accession)
phos.dat$Gene <- sub("(.*)-.*$", "\\1", phos.dat$site)

# from here we can select just the metadata of interest
metadata.columns = c('Sample','BeatAML Patient ID','Plex','Loading Mass', 'Description')
summary <- phos.dat%>%
  select(metadata.columns)%>%
  distinct()
summary$Description <- as.character(summary$Description)
summary$Type <- case_when(summary$`BeatAML Patient ID` == "Healthy Donor Stroma" ~ "Healthy Donor Stroma",
                          summary$`BeatAML Patient ID` == "Cell line" ~ "Cell line")
summary[is.na(summary$Type), "Type"] <- "Treated"

## Elie has corrected the time period annotation. Adding a pre-treatment, early, and late period.
correct.time.annotation <- as.data.frame(read_csv("../Updated time period annotation.csv"))
summary$Period <- correct.time.annotation[summary$Sample, "Classification"]
summary$Period <- case_when(grepl("early", summary$Period) ~ "Early",
                            grepl("Late", summary$Period) ~ "Late",
                            grepl("pre-treatment", summary$Period) ~ "Pre-Treatment")
```

Below we show only the metadata for the 7 patients.

```{r metadata, echo=FALSE}

show <- subset(summary, Type == "Treated") %>%
  select(`BeatAML Patient ID`, Period, Plex, Description) %>%
  dplyr::rename(ID = `BeatAML Patient ID`) %>%
  arrange(ID, Period) %>%
  mutate(Plex = as.character(Plex))

kbl(show) %>%
  kable_paper("hover", full_width = F)

```

### KSEA Heatmap Early vs Pre-Treatment - Phosphosite Plus + NetworKIN

Six of the seven patients have both a Pre-treatment and Early time point. From these 6 samples, 3 consist 
of only two time points (Pre-treatment and Early) while the other 3 have multiple Early time points. 
We use these 6 patients to run KSEA (using the Phosphosite Plus + NetworKIN database) to compare the Early period 
to the Pre-Treatment period for each sample. After collecting these enrichment results, we re-adjust 
the p-values using "BH" (Benjamini Hochberg) correction. We select only the top 50 most enriched
pathways and select those with an adjusted p-value below 0.05. 

In these plots, red indicates increased activity in the Early period, while blue shows increased
activity in the Pre-Treatment period. Moreover, the asterisk indicates an adjusted p-value below 0.05 for 
that particular patient + pathway.

We use the z-score for each pathway + patient combination in the heatmap.

```{r fig.show='hold', fig.align='center', fig.cap=c("LEFT: Phosphosite Plus ---- RIGHT: Phosphosite Plus & NetworKIN")}
knitr::include_graphics("Making Plots/Kinase heatmap Early vs Pre-Treatment - Phosphosite Plus + NetworKIN.png")
```

### KSEA Heatmap Late vs Early - Phosphosite Plus + NetworKIN

Only two of the seven patients have a late time point, namely "5029" and "5104". "5029" consists of only two
time points, while "5104" has a total 6; however 1 of these 6 time points corresponds to the Pre-Treatment period.
We use these 2 patients to run KSEA (using the Phosphosite Plus + NetworKIN database) to compare the Late period 
to the Early period for each sample. After collecting these enrichment results, we re-adjust 
the p-values using "BH" (Benjamini Hochberg) correction. We select only the top 50 most enriched
pathways and select those with an adjusted p-value below 0.05. 

In these plots, red indicates increased activity in the Late period, while blue shows increased
activity in the Early period. Moreover, the asterisk indicates an adjusted p-value below 0.05 for 
that particular patient + pathway.

We use the z-score for each pathway + patient combination in the heatmap. 

```{r fig.show='hold', fig.align='center', fig.cap=c("LEFT: KEGG ---- RIGHT: REACTOME")}
knitr::include_graphics("Making Plots/Kinase heatmap Late vs Early - Phosphosite Plus + NetworKIN.png")
```









